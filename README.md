# Azurite V3

> Note:
> Azurite V2 has been moved to [legacy-master](https://github.com/Azure/azurite/tree/legacy-master) branch.
> Master branch has been updated with latest Azurite V3.

## Introduction

Azurite is an open source Azure Storage API compatible server (emulator). Based on Node.js, Azurite provides a cross platform experiences for customers wanting to try Azure Storage easily in a local environment. Azurite simulates most of the commands supported by it with minimal dependencies.

AzuriteV2 is manually created with pure JavaScript, popular and active as an open source project. However, Azure Storage APIs are growing and keeping updating, manually keeping Azurite up to date is not efficiency and easily to have bugs. JavaScript also doesn’t provide strong type validation which prevent large scale cooperation.

Comparing with V2, Azurite V3 applies a new architecture which leverages code generated by a TypeScript Server code generator we created. The generator uses the same swagger (modified) used by Azure Storage V10 SDKs. This reduces lots of manual efforts and easily keeps the generated code alignment with storage APIs. 3.0.0-preview is the first release after Azurite applied new architecture.

## Features & Key Changes in Azurite V3

- Blob storage features align with Azure Storage API Version 2018-03-28 (refer to following support matrix section)
  - SharedKey/Account SAS/Service SAS/Public Access Authentications
  - Get/Set Blob Service Properties
  - Create/List/Delete Containers
  - Create/Read/List/Update/Delete Block Blobs
  - Create/Read/List/Update/Delete Page Blobs
- Features **NEW** on V3
  - Built with TypeScript and ECMA native promise and async features
  - New architecture based on TypeScript server generator. Leverage auto generated protocol layer, models, serializer, deserializer and handler interfaces from REST API swagger
  - Flexible structure and architecture, supports customizing handler layer implementation, persistency layer implementation, multi storage accounts, HTTP pipeline middleware injection
  - Detailed debugging log support, easy bug locating and reporting
  - Works with storage .Net SDK basic and advanced sample
  - SharedKey, AccountSAS, ServiceSAS, Public Access authentication support
  - API version targeting 2018-03-28 (See support matrix)

## Getting Started

Try with any of following ways to start an Azurite instance.

### GitHub

After cloning source code, execute following commands to start Azurite V3. Take blob service as example:

```bash
npm install
npm run blob
```

### NPM

In order to run Azurite V3 you need Node.js >= 8.0 installed on your system. Azurite works cross-platform on Windows, Linux, and OS X.

After installation you can install Azurite simply with npm which is Node.js package management tool and which is included with every Node.js installation.

```cmd
npm install -g azurite
```

Simply start it with the following command:

```cmd
azurite -s -l c:\azurite -d c:\azurite\debug.log
```

or,

```cmd
azurite --silent --location c:\azurite --debug c:\azurite\debug.log
```

This tells Azurite to store all data in a particular directory. If the -l option is omitted it will use the current working directory. You can also selectively start the different storage services.

For Blob Storage Service only:

```bash
$ azurite-blob -l path/to/azurite/workspace
```

### DockerHub

TODO

### Visual Studio Code Extension

TODO

### NuGet

TODO

## Usage with Azure Storage SDKs or Tools

### Default Storage Account

Azurite V3 supports a default account as General Storage Account V2 and provide features as a GPV2 account.

- Account name: `devstoreaccount1`
- Account key: `Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==`

> Note. Besides SharedKey authentication, Azurite V3 also supports account and service SAS authentication. Anonymous access is available when container is set to be public access.

### Connection String

Typically you can pass following connection strings to SDKs or tools (like Azure CLI2.0 or Storage Explorer)

Take Blob service as example, full connection string is:

```
DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;
```

Or if the SDK or tools support following short connection string:

```
UseDevelopmentStorage=true;
```

### Storage Explorer

Connect to Azurite by click "Add Account" icon, then select "Attach to a local emulator" and click "Connect".

## Supported Command Line Options

### Listening Host Configuration

Optional. By default, Azurite V3 will listen to 127.0.0.1 as a local server.
You can customize the listening address per your requirements.

#### Only Accept Requests in Local Machine

```cmd
--blobHost 127.0.0.1
```

#### Allow Accepting Requests from Remote (potentially unsafe)

```cmd
--blobHost 0.0.0.0
```

### Listening Port Configuration

Optional. By default, Azurite V3 will listen to 10000 as blob service port.
You can customize the listening port per your requirements.

#### Customize Blob Service Listening Port

```cmd
--blobPort 8888
```

#### Let System Auto Select an Available Port

```cmd
--blobPort 0
```

### Workspace Path Configuration

Optional. Azurite V3 needs to persist metadata and binary data to local disk during execution.

You can provide a customized path as the workspace location, or by default, Azurite V3's process working directory will be used.

```cmd
-l c:\azurite
--location c:\azurite
```

###

### Access Log Configuration

Optional. By default Azurite will display access log in console. Disable it by:

```cmd
-s
--silent
```

### Debug Log Configuration

Optional. Debug log includes detailed information for every requests and exception stack traces. Enable it by providing a valid local file path as debug log destination:

```
-d path/debug.log
--debug path/debug.log
```

### Command Line Options Differences between AzuriteV2

Azurite V3 supports SharedKey, Account Shared Access Signature (SAS), Service SAS and Public Container Access authentications, you can use any Azure Storage SDKs or tools like Storage Explorer to connect Azurite V3 with any authentication strategy.

Following option to bypass authentication is **NOT** provided anymore.

```
-a
```

## Differences between Azurite and Azure Storage Service

Because the Azurite is an environment running in a local persistency instance, there are differences in functionality between Azurite and an Azure storage account in the cloud.

### Storage Accounts

> Please reach to us or open issues if you want multi storage account support.

Azurite V3 supports a default account as General Storage Account V2 and provide features as a GPV2 account.

- Account name: `devstoreaccount1`
- Account key: `Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==`

### Endpoint & Connection URL

The service endpoints for Azurite are different from those of an Azure storage account. The difference is because the local computer does not perform domain name resolution, requiring Azurite endpoints to be local addresses.

When you address a resource in an Azure storage account, you use the following scheme. The account name is part of the URI host name, and the resource being addressed is part of the URI path:

```
<http|https>://<account-name>.<service-name>.core.windows.net/<resource-path>
```

For example, the following URI is a valid address for a blob in an Azure storage account:

```
https://myaccount.blob.core.windows.net/mycontainer/myblob.txt
```

However, because the local computer does not perform domain name resolution, the account name is part of the URI path instead of the host name. Use the following URI format for a resource in Azurite:

```
http://<local-machine-address>:<port>/<account-name>/<resource-path>
```

For example, the following address might be used for accessing a blob in Azurite:

```
http://127.0.0.1:10000/myaccount/mycontainer/myblob.txt
```

The service endpoints for Azurite Blob service:

```
http://127.0.0.1:10000/<account-name>/<resource-path>
```

### Scalability & Performance

> Please reach to us if you have requirements or suggestions for a distributed Azurite implementation or higher performance.

Azurite is not a scalable storage service and does not support many concurrent clients. There is also no performance and TPS guarantee, they highly depend on the environments Azurite has deployed.

### Error Handling

> Please reach to us if you have requirements or suggestions for a specific error handling.

Azurite will try best to align with Azure Storage error handling logic, but CANNOT do 100% alignment, such as error messages (returned in error response body) maybe different (Error status code will align). Because of following reasons:

- No detailed rules defined on Azure Storage online documentation
- Many logical errors cannot be defined in swagger definitions
- For a request with more than 1 logical error, it’s up to implementation to decide throw which error firstly
- Other structure related unexpected errors proposed by Azure Storage, like Partition Layer errors

There is a typical example describing the challenge to fully align with server behavior. For download blob range operation, when the request range headers exceed the blob length. Azure Storage server will just return the data it has, instead returning an error. While this behavior doesn’t get recorded in the REST documents.

### API Version Compatible Strategy

Azurite V3 follows a **Try best to serve** compatible strategy with Azure Storage API versions:

- Every Azurite V3 will have a baseline Azure Storage API version. Swagger definition with the same API version will be used to generate protocol layer APIs. Azurite should implement all the possible features provided in this API service version.
- If an incoming request has **the same API version** Azurite provides, Azurite should handle the request same with Azure Storage
- If an incoming request has a **higher API version** than Azurite, Azurite will return a VersionNotSupportedByEmulator error (HTTP status code 400 - Bad Request).
- If an incoming request has a **lower API version** header with Azurite, Azurite will try to handle the request with Azurite’s baseline API version behavior instead of customer selected.
  - If the REST API keeps the same behavior in these 2 API versions, Azurite should handle well. This covers most of the REST APIs.
  - If the REST API behaviors different between 2 versions (breaking changes), Azurite will not behave the old API version.
    - Minor APIs have breaking changes cross API versions. Possible related APIs such as ETag
- Azurite will return API version in response header always the baseline API version
- SAS accepts pattern from API version 2015-04-05

### RA-GRS

Azurite supports read-access geo-redundant replication (RA-GRS). For storage resources both in the cloud and in the local emulator, you can access the secondary location by appending -secondary to the account name. For example, the following address might be used for accessing a blob using the read-only secondary in Azurite:

```
http://127.0.0.1:10000/devstoreaccount1-secondary/mycontainer/myblob.txt
```

## Differences between Azurite V3 and Azurite V2

Both Azurite V3 and Azurite V2 aim to provide a convenience experience for customers quickly play with Azure Storage service on local. There are lots of differences between Azurite V3 and legacy Azurite V2.

### Architecture

Architecture in Azurite V3 has been refactored, it's more flexible and robust. It provides the flexibility to support following scenarios in the future:

- Use other HTTP frameworks instead of express.js
- Customized a new handler layer implementation, such as redirect requests to Azure Storage services
- Implement and inject a persistency layer implementation, such as based on
- Provide multi azure storage accounts authentication and support
- Detailed debug log for easy issue investigation and request tracking
- Create HTTPS server
- ...

### Server Code Generator

Azurite V3 leverages a TypeScript server code generator based on Azure Storage REST API swagger specifications. This reducing manual efforts and also makes sure API implementation alignment.

### TypeScript

Azurite V3 selects TypeScript as default programming language because it's more suitable for cooperation while making sure the quality.

### Features Scope

Legacy Azurite V2 supports Azure Storage Blob, Queue and Table services. Azurite V3 now only supports Azure Storage Blob Service, and going to support Queue soon. Table service support is under discussion too.

Azurite V3 supports features in Azure Storage API version 2018-03-28, and going to keep update with latest API versions in a finer updating frequency than legacy Azurite V2.

## Welcome Contributions!

We are currently working on Azurite V3 to implement Azure Storage REST APIs. And currently we finished the basic structure and majority of features. Just like you can see in the support matrix. The detailed working items are also tracked in GitHub repository projects and issues.

Any contribution to Azurite V3 is welcome, please goto `CONTRIBUTION.md` for detailed contribution guideline. Or you can open GitHub issues voting for any missing features in Azurite V3.

## TypeScript Server Code Generator

Azurite V3 leverages a TypeScript Node.js server code generator to generate majority of code from Azure Storage REST APIs swagger specification. Currently, the generator project is private, under development and only used by Azurite V3. We have a plan to make the TypeScript server generator public after Azurite V3 releases. All the generated code is kept in `generated` folder, including the generated middleware, request and response models.

## Support Matrix

3.0.0-preview release targets **2018-03-28** API version **blob** service. Detailed support matrix is here.

- Supported Vertical Features
  - SharedKey Authentication
  - Shared Access Signature Account Level
  - Shared Access Signature Service Level (Not support response header override in service SAS)
  - Container Public Access
- Supported REST APIs
  - List Containers
  - Set Service Properties
  - Get Service Properties
  - Get Stats
  - Get Account Information
  - Create Container
  - Get Container Properties
  - Get Container Metadata
  - Set Container Metadata
  - Get Container ACL
  - Set Container ACL
  - Delete Container
  - Lease Container (Access control based on lease is partial support)
  - List Blobs
  - Put Blob (Create append blob is not supported)
  - Get Blob
  - Get Blob Properties
  - Set Blob Properties
  - Get Blob Metadata
  - Set Blob Metadata
  - Lease Blob (access control based on lease is partial support)
  - Snapshot Blob
  - Copy Blob (Only supports copy within same account in Azurite)
  - Abort Copy Blob (Only supports copy within same account in Azurite)
- Following features or REST APIs are NOT supported or limited supported in this release (will support more features per customers feedback in future releases)
  - OAuth authentication
  - Access control based on conditional headers, container/blob lease (lease control is limited supported)
  - CORS and Preflight
  - Static Website
  - Soft delete & Undelete Blob
  - Put Block from URL
  - Incremental Copy Blob
  - Create Append Blob, Append Block

## License

This project is licensed under MIT.

## Contributing

This project welcomes contributions and suggestions. Most contributions require you to agree to a
Contributor License Agreement (CLA) declaring that you have the right to, and actually do, grant us
the rights to use your contribution. For details, visit <https://cla.microsoft.com.>

When you submit a pull request, a CLA-bot will automatically determine whether you need to provide
a CLA and decorate the PR appropriately (e.g., label, comment). Simply follow the instructions
provided by the bot. You will only need to do this once across all repos using our CLA.

This project has adopted the [Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/).
For more information see the [Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or
contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any additional questions or comments.
